blueprint:
  name: AI Event Summary with Telegram (Enhanced v1.6.3.5)
  author: valentinfrlch (modified for Telegram - rebuilt)
  homeassistant:
    min_version: 2024.10.0
  description: >
    AI-powered camera event summaries with Telegram integration. Hotfix 1.6.3.5 - snapshot image and plain description working.

  domain: automation

  input:
    telegram_section:
      name: Telegram Settings
      icon: mdi:telegram
      input:
        telegram_target:
          name: Telegram Chat ID
          description: The chat ID to send notifications to
          selector:
            text: {}
        notification_time:
          name: Notification Time Format
          description: Add time to notification messages
          default: 12hour
          selector:
            select:
              options:
                - label: No Time Added
                  value: none
                - label: 12 Hour Format (3:45 PM)
                  value: 12hour
                - label: 24 Hour Format (15:45)
                  value: 24hour
    camera_section:
      name: Camera Settings
      icon: mdi:camera
      input:
        camera_entities:
          name: Camera Entities
          description: Camera entities to monitor (can select multiple)
          selector:
            entity:
              multiple: true
              domain: camera
    ai_section:
      name: AI Analysis Settings
      icon: mdi:brain
      input:
        ai_prompt:
          name: AI Analysis Prompt
          description: Prompt sent to AI for analyzing camera footage
          default: >
            Describe what you see in this security camera footage. Focus on any people,
            vehicles, or notable activity. Be concise.
          selector:
            text:
              multiline: true

variables:
  camera_entities: !input camera_entities
  telegram_target: !input telegram_target
  ai_prompt: !input ai_prompt
  notification_time: !input notification_time

  camera_entity: "{{ camera_entities[0] }}"
  cam_slug: "{{ camera_entity | replace('camera.', '') | replace('_', '-') }}"
  snapshot_path: "/config/www/snapshots/{{ cam_slug }}_snapshot.jpg"
  time_string: >
    {% if notification_time == '12hour' %}
      {{ now().strftime("%-I:%M %p") }}
    {% elif notification_time == '24hour' %}
      {{ now().strftime("%H:%M") }}
    {% else %}
      {{ "" }}
    {% endif %}

trigger:
  - platform: state
    entity_id: !input camera_entities
    to: "recording"

action:
  - service: camera.snapshot
    data:
      entity_id: "{{ camera_entity }}"
      filename: "{{ snapshot_path }}"

  - service: telegram_bot.send_photo
    data:
      target: "{{ telegram_target }}"
      file: "{{ snapshot_path }}"
      caption: |
        ðŸ“¸ [{{ camera_entity }}]
        {{ ai_prompt }}
        {{ time_string }}

mode: single
